<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- arch-tag: f0db8795-3291-41bc-a66e-def764bfc8ef (do not change this
comment) -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
    
    <head>
        <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
        <title>Gmap GPS Track Plotting</title>.js
        <!--<script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAL59Tsr1MEwFJIycfVERYLxTQdP3wB3SgI83I0xmzqa7bxq-EhRSALll7LsL49FCJZVC4GF3xU7pneg"
        type="text/javascript"></script>-->
        <!--<script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAASI0kCI-azC8RgbOZzWc3VRRarOQe_TKf_51Omf6UUSOFm7EABRRhO0PO4nBAO9FCmVDuowVwROLo3w"
        type="text/javascript"></script>-->
        <!--<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDdfZ991xmwxK_3DfPpFROX20AtvRiCKtQ&sensor=false"></script>-->
        <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>	-->
        <!-- <script src="http://maps.google.com/maps/api/js?sensor=false&amp;key=AIzaSyDdfZ991xmwxK_3DfPpFROX20AtvRiCKtQ"
        type="text/javascript"></script> -->
        <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>-->
        <!--<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.js"></script>-->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.20/themes/base/jquery-ui.css"
        type="text/css" media="all" />
        <link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css"
        type="text/css" media="all" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"
        type="text/javascript"></script>
        <script src="http://code.jquery.com/ui/1.8.20/jquery-ui.min.js"
        type="text/javascript"></script>
        <script src="http://jquery-ui.googlecode.com/svn/tags/latest/external/jquery.bgiframe-2.1.2.js"
        type="text/javascript"></script>
        <script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/minified/i18n/jquery-ui-i18n.min.js"
        type="text/javascript"></script>
        <script type="text/javascript" src="http://openlayers.org/api/OpenLayers.js"></script>
        <!-- <script type="text/javascript" src="http://timemap.googlecode.com/svn/tags/2.0.1/lib/mxn/mxn.js?(openlayers)"></script>-->
        <script type="text/javascript" src="./timemap/lib/mxn/mxn.js?(openlayers)"></script>
        <!--<script type="text/javascript" src="http://timemap.googlecode.com/svn/tags/2.0.1/lib/mxn/mxn.js?(googlev3)"></script> -->
        <!--<script src="gpstracks_files/map.js" type="text/javascript"></script> -->
        <!-- <script src="gpstracks_files/main.js" type="text/javascript"></script>-->
        <!--<style type="text/css">@media print{.gmnoprint{display:none}}@media screen{.gmnoscreen{display:none}}</style>-->
        <script src="gpstracks_mxn_files/reqcache.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/gmapgpx.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/geo.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/colors.js" type="text/javascript"></script>
        <!--<script src="gpstracks_files/mod_dragmod_ctrapi.js" charset="UTF-8"
        type="text/javascript"></script>-->
        <style type="text/css">
            #slider {
                border: 2px solid #000;
                width: 75%;
                margin-right: 260px;
            }
            #map_ol {
                height: 500px;
                border: 2px solid #000;
                width: 75%;
                margin-right: 260px;
                margin-left: 10px;
            }
            #info {
                position: absolute;
                top: 300px;
                right: 5px;
                width: 200px;
                font-size: 80%;
                border: 1px solid #000;
                padding-left: 1em;
                padding-right: 1em;
                font-family: Helvetica, Arial, sans-serif;
            }
            #title {
                text-align: center;
                font-family: Helvetica, Arial, sans-serif;
            }
            #intro {
                height: 250px;
                font-size: 80%;
                font-family: Helvetica, Arial, sans-serif;
            }
            .desc {
                text-align: center;
            }
            .info img {
                float: left;
            }
            #zselect {
                padding-top: 1em;
            }
            v\:* {
                behavior:url(#default#VML);
            }
        </style>
        <style>
            .play {
                width:24px;
                height:24px;
                background-image: url(Play24.gif);
                float:left;
            }
            .pause {
                width:24px;
                height:24px;
                background-image: url(Pause24.gif);
                float:left;
            }
	    #lsbox {
                width:120px;
            }
        </style>
        <script type="text/javascript">
            //<![CDATA[
            var map = null;
            var speed_mult = 0;
            var fcancel = null;
            var maxZ = 0;
	    var tracks = new Array();
	    var start = 0.0;
	    var end;
	    var isSetup = false;

            function initialize() {
                // Start with animation disabled
                var e = document.getElementById("speed");
                e.options[0].selected = 1;
                speed_mult = 0;

                //~ e = document.getElementById("zmax");
                //~ e.disabled = true;
                //~ e.options[0].selected = 1;
                maxZ = 0;

                //~ e = document.getElementById("varcolor");
                //~ e.checked = false;
                //~ e.disabled = true;

                map = new mxn.Mapstraction(document.getElementById("map_ol"), "openlayers", true);

                // set default controls and map type
                map.addControls({
                    pan: true,
                    zoom: true ? 'large' : false,
                    map_type: true
                });

                map.setMapType(mxn.Mapstraction.ROAD);

                var tracksShown = false;

                //~ if (window.location.search) {
                    //~ // Was a file specified?
                    //~ var params = window.location.search.slice(1).split("&");
                    //~ var vals = new Array(params.length);
                    //~ for (var i = 0; i < params.length; i++) {
                        //~ var item = params[i].split("=");
                        //~ vals[item[0]] = item[1];
                    //~ }

                    //~ if (vals["files"]) {
                        //~ if (vals["zoom"]) {
                            //~ zoom = parseInt(vals["zoom"]);
                        //~ } else {
                            //~ zoom = 4;
                        //~ }

                        //~ tracksShown = true;
                        //~ showtracks(vals["files"], zoom);
                    //~ }
                //~ }

                if (!tracksShown) {
                    // display the map centered on a latitude and longitude
                    var startpt = new mxn.LatLonPoint(35, -95);
                    map.setCenterAndZoom(startpt, 5);
                }

            }

            function set_speed_mult(val) {
                // Disable elevation-based line coloring when
                // animation is disabled.
                //~ var e = document.getElementById("varcolor");

                speed_mult = val;
                //~ if (speed_mult == 0) {
                    //~ e.checked = false;
                    //~ e.disabled = true;
                //~ } else {
                    //~ e.disabled = false;
                //~ }
            }

            //~ function show_elev(box) {
                //~ var sel = document.getElementById("zmax");
                //~ if (box.checked) {
                    //~ sel.disabled = false;
                //~ } else {
                    //~ maxZ = 0;
                    //~ sel.options[0].selected = 1;
                    //~ sel.disabled = true;
                //~ }
            //~ }

            // Display all of the tracks from a GPX file at the specified
            // zoom level. Input from the UI determines whether we will
            // animate the track or display it statically.
	    // todo - add a start time 
	    // if 0 or undefined run  setup
	    // else just animate or display
            function showtracks() {
                var colors = ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#00ffff", "#ff00ff", "#000000", "#ffffff"],
		zoom = 5;

                map.removeAllMarkers();
                map.removeAllPolylines();

                // Setup function to center and zoom the map appropriately
                // to display the tracks
                var f_setup = function (f_next) {	                        
			var tracksLength = tracks.length;
                        var theMinLon = 180.0;
                        var theMaxLon = -180.0;
                        var theMinLat = 90.0;
                        var theMaxLat = -90.0;
			var badFiles = new Array();

                        for (var i = 0; i < tracksLength; ++i) {
                            var bounds = tracks[i].theBounds;
			    
			    if(bounds === null){
			         var theFileName = tracks[i].fileName;
				 badFiles.push(theFileName);
			    } else {
				    theMinLon = Math.min(theMinLon, bounds.sw.lon);
				    theMaxLon = Math.max(theMaxLon, bounds.ne.lon);
				    theMinLat = Math.min(theMinLat, bounds.sw.lat);
				    theMaxLat = Math.max(theMaxLat, bounds.ne.lat);
			    }
                        };

                        var centerLon = (theMaxLon + theMinLon) / 2.,
                            centerLat = (theMinLat + theMaxLat) / 2.;

                        // Try to determine the best zoom level using the bounding-box
                        // information from the file.
                        var theBounds = {
                            minX: theMinLon,
                            maxX: theMaxLon,
                            minY: theMinLat,
                            maxY: theMaxLat
                        };

                        // Google map zoom is different to OpenLayers zoom
                        zoom = 17 - best_zoom(theBounds, document.getElementById("map_ol"));
                        map.setCenterAndZoom(new mxn.LatLonPoint(centerLat, centerLon), zoom);

                        isSetup = true;
                        f_next();
                    }

                    // Animate the tracks
                var f_animate = function () {
                        var tracksLength = tracks.length;

                        for (var i = 0; i < tracksLength; ++i) {
                            fcancel = tracks[i].animate(map, colors, speed_mult, maxZ);
                        }
                    };

                // Display the tracks.
                var f_display = function () {
                        var tracksLength = tracks.length;

                        for (var i = 0; i < tracksLength; ++i) {
                            tracks[i].display(map, colors, start, end);
                        }
                    };


                if (speed_mult == 0) {
		    if(isSetup){
		        f_display();
		    } else {
		       f_setup(f_display);
		    }
                    //~ setTimeout(function () {
                        //~ f_setup(f_display);
                    //~ }, 250);
                    //fetch_gpx(file, function(gpx) { f_setup(gpx, f_display); });
                } else {
		    if(isSetup){
		        f_animate();
		    } else {
		       f_setup(f_animate);
		    }
                    //~ setTimeout(function () {
                        //~ f_setup(f_animate);
                    //~ }, 250);
                    //fetch_gpx(file, function(gpx) { f_setup(gpx, f_animate); });
                }
            }

	function listbox_remove(sourceID) {
                //get the listbox object from id.
                var src = document.getElementById(sourceID);
		var removedItems = new Array();

                //iterate through each option of the listbox
                for (var count = src.options.length - 1; count >= 0; count--) {
                    //if the option is selected, delete the option
                    if (src.options[count].selected == true) {
		        var itemText = src.options[count].text;
			removedItems.push(itemText);
			
                        try {
                            src.remove(count, null);
                        } catch (error) {
                            src.remove(count);
                        }
                    }
                }

		// TODO - rebuild the tracks - but do not re-fetch
                //~ var tracksLength = tracks.length;
		//~ for (var i = tracksLength - 1; i >= 0; i--) {
		    //~ if(tracks.
		//~ }
		isSetup = false;
            }
	    
	    function completeAdd(theTrack){
		tracks.push(theTrack);
		isSetup = false;
		
		var listBox = document.getElementById('lsbox');

                var listBoxItem = document.createElement("option");
                listBoxItem.value = theTrack.fileName;
                listBoxItem.text = theTrack.fileName;
                listBox.add(listBoxItem, null);	    
	    }
	    
	    function errorAdd(itemText){
	    // todo just move this as an alert to GPSTrack
	    }

            function addNewListItem() {
		var listBox = document.getElementById('lsbox');
                var itemValue = document.getElementById('txtValue');

                if (itemValue.value == '') {
                    alert('please enter option value');
                    itemValue.focus();
                    return false;
                }

                if (isOptionAlreadyExist(listBox, itemValue.value)) {
                    alert('already exists');
                    itemValue.focus();
                    return false;
                }
		
		var theTrace = new GPSTrack(itemValue.value, completeAdd, errorAdd);
                var fetched = theTrace.fetch();

                return true;
            }

            function isOptionAlreadyExist(listBox, value) {
                var exists = false;
                for (var x = 0; x < listBox.options.length; x++) {
                    if (listBox.options[x].value == value || listBox.options[x].text == value) {
                        exists = true;
                        break;
                    }
                }
                return exists;
            }
	    
	                //]]>
			
	    </script>

		<script type="text/javascript">
	$(function() {
		$( "#slider" ).slider({
			value:0,
			min: 0,
			max: 100,
			step: 1,
			slide: function( event, ui ) {
			        var sliderValue = ui.value;
				end = sliderValue;
				$( "#amount" ).val(ui.value );
				// rather put showtracks
				// put fdisplay in here - need setup also
				// could just call showtracks??
			}
		});
		$( "#amount" ).val($( "#slider" ).slider( "value" ) );
	});
	</script>
        <script type="text/javascript">
            $(document).ready(function () {
                $('#toggle').bind("click", function () {
                    if ($(this).attr("class") == "play"){
		    // add a time to showtracks so that it knows where it was paused
			showtracks();
		        $(this).attr("class", "pause");
                   } else {
		   // TODO - need this to cancel all
		   // or actually pause so that play can resume
			if(fcancel){
			    fcancel();
			    }
			   $(this).attr("class", "play");
		       }
                });
            });
        </script>
    </head>
    
    <body onload="initialize()">
        <div id="intro">
            <h2 id="title">GPS Track Plotting/Animation Demo</h2>
            <p>This page uses Google's new
                <a href="http://maps.google.com/apis/maps/documentation/">Mapping API</a>to plot and optionally animate various GPS tracks. Each example track
                is stored in a
                <a href="http://www.topografix.com/gpx.asp">GPX-format</a>XML file.</p>
            <h3 class="subhead">Animation</h3>
            <p>The animation update interval is determined by the time between trackpoints.
                You can play the animation in real-time (this can be rather slow) or some
                multiple thereof. There is also the option of elevation dependent coloring
                for each trackpoint interval. The color range is a linear progression in
                <a
                href="http://gug.sunsite.dk/docs/Grokking-the-GIMP-v1.0/node51.html">hue</a>(i.e. around the color wheel) from zero to the specified maximum
                    elevation.</p>
            <h3 class="subhead">Source code</h3>
            <p>The GPX handling is provided by the functions in
                <a href="http://home.mindspring.com/%7Emfkenney/gmapgpx.js">gmapgpx.js</a>and the color conversion is done in
                <a href="http://home.mindspring.com/%7Emfkenney/colors.js">colors.js</a>.</p>
        </div>
        <p>
	<p>
	<label for="amount">Donation amount ($50 increments):</label>
	<input type="text" id="amount" style="border:0; color:#f6931f; font-weight:bold;" />
	</p>
            <div id="slider"></div>
        </p>
        <div style="background-color: rgb(229, 227, 223);" id="map_ol">
            <div id="info">
                <p>Select animation speed:</p>
                <form>
                    <select id="speed" name="speed" size="1" onchange="set_speed_mult(this.options[this.selectedIndex].value)">
                        <option selected="selected" value="0">no animation</option>
                        <option value="1">real-time</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                        <option value="20">20x</option>
                        <option value="50">50x</option>
                    </select>
		    <!--
                    <div id="zselect">
                        <input disabled="disabled" name="varcolor" id="varcolor" onclick="show_elev(this)"
                        type="checkbox">
                        <span>Vary line color with elevation?</span>
                    </div>
                    <select id="zmax" name="zmax" size="1" disabled="disabled" onchange="maxZ=this.options[this.selectedIndex].value"
                    title="Determines color scale for the track">
                        <option value="0" selected="selected">Select maximum elevation</option>
                        <option value="50">50 meters</option>
                        <option value="100">100 meters</option>
                        <option value="200">200 meters</option>
                        <option value="500">500 meters</option>
                        <option value="1000">1000 meters</option>
                    </select>-->
                </form>
                <p>Choose a set of GPS tracks to plot. Animation/plotting will start when
                    you select the link. Use the STOP button to cancel the animation:</p>
		    
        <table>
            <tr>
                <td align="left">
                    <input name="txtValue" type="text" id="txtValue"
                    />
                </td>
            </tr>
            <tr>
                <td align="center">
                    <button name="btnAddItem" id="btnAddItem" onclick="javascript:addNewListItem();">Add</button>
                </td>
                <tr>
                    <tr>
                        <td align="center">
                            <select id="lsbox" name="lsbox" size="10" multiple>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td align="center">
                            <button onclick="listbox_remove('lsbox');">Delete</button>
                        </td>
                    </tr>
        </table>
   <!--             <ul>
                    <li>
                        <a href="javascript:showtracks('disney.xml',%200)">Disneyland
        walk</a>
                    </li>
                    <li>
                        <a href="javascript:showtracks('test.xml,bikecommute.xml,bikecommute2.xml,bike20050725.xml',%203)">Bike
        commute</a>
                    </li>
                    <li>
                        <a href="javascript:showtracks('bikecommute.xml',%203)">Bike
        commute 2</a>
                    </li>
                    <li>
                        <a href="javascript:showtracks('bikecommute2.xml',%203)">Bike
        commute 3</a>
                    </li>
                    <li>
                        <a href="javascript:showtracks('bike20050725.xml',%203)">Bike
        commute 4</a>
                    </li>
                    <li>
                        <a href="javascript:showtracks('logs.xml',%206)">Road
        trip</a>(this one is
                        <b>long</b>)</li>
                    <li>
                        <a href="javascript:showtracks('pubride.xml',%203)">Portland Pub Ride</a>
                    </li>
                </ul> -->
                <form>
                    <!-- TODO - change this to a play pause button and add the play pause
                    functionality -->
                    <!-- add a slider and animate it in sync with the tracks -->
                    <div id="toggle" class="play"></div>
                    <!--<input value="STOP ANIMATION" onclick="if(fcancel) fcancel()"
                    type="button">-->
                </form>
            </div>
            <!-- <div class="demo">-->
            <!-- </div>-->
    </body>

</html>