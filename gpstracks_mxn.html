<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- arch-tag: f0db8795-3291-41bc-a66e-def764bfc8ef (do not change this
comment) -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
    
    <head>
        <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
        <title>Gmap GPS Track Plotting</title>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.20/themes/base/jquery-ui.css"
        type="text/css" media="all" />
        <link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css"
        type="text/css" media="all" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"
        type="text/javascript"></script>
        <script src="http://code.jquery.com/ui/1.8.20/jquery-ui.min.js"
        type="text/javascript"></script>
        <script src="http://jquery-ui.googlecode.com/svn/tags/latest/external/jquery.bgiframe-2.1.2.js"
        type="text/javascript"></script>
        <script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/minified/i18n/jquery-ui-i18n.min.js"
        type="text/javascript"></script>
        <script type="text/javascript" src="http://openlayers.org/api/OpenLayers.js"></script>
        <!-- <script type="text/javascript" src="http://timemap.googlecode.com/svn/tags/2.0.1/lib/mxn/mxn.js?(openlayers)"></script>-->
        <script type="text/javascript" src="./timemap/lib/mxn/mxn.js?(openlayers)"></script>
        <script src="gpstracks_mxn_files/reqcache.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/gmapgpx.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/geo.js" type="text/javascript"></script>
        <script src="gpstracks_mxn_files/colors.js" type="text/javascript"></script>
        <style type="text/css">
            #slider {
                border: 2px solid #000;
		margin-left: 56px;
            }
	   #map_table {
                width: 75%;
            }
            #map_ol {
                height: 500px;
                border: 2px solid #000;
                margin-left: 10px;
            }
            #info {
                position: absolute;
                top: 300px;
                right: 5px;
                width: 200px;
                font-size: 80%;
                border: 1px solid #000;
                padding-left: 1em;
                padding-right: 1em;
                font-family: Helvetica, Arial, sans-serif;
            }
            #title {
                text-align: center;
                font-family: Helvetica, Arial, sans-serif;
            }
            #intro {
                height: 250px;
                font-size: 80%;
                font-family: Helvetica, Arial, sans-serif;
            }
            .desc {
                text-align: center;
            }
            .info img {
                float: left;
            }
            #zselect {
                padding-top: 1em;
            }
            v\:* {
                behavior:url(#default#VML);
            }
	    
            .play {
                width:24px;
                height:24px;
                background-image: url(Play24.gif);
                float:left;
            }
            .pause {
                width:24px;
                height:24px;
                background-image: url(Pause24.gif);
                float:left;
            }
	    #lsbox {
                width:180px;
            }
	    #stop {
                width:24px;
                height:24px;
                background-image: url(Stop24.gif);
                float:left;
            }
        </style>
        <script type="text/javascript">
            //<![CDATA[
            var map = null;
            var speed_mult = 0;
            var fcancel = null;
            var maxZ = 0;
	    var tracks = new Array();
	    var start = 0.0;
	    var end;
	    var isSetup = false;
	    var longestTimeOffset;
	    var sliderTimeIncrement = 0.0;
	    var goingBackwards = false;
	    var showIncrement = false;

            function initialize() {
                // Start with animation disabled
                var e = document.getElementById("speed");
                e.options[0].selected = 1;
                speed_mult = 0;
                maxZ = 0;

                map = new mxn.Mapstraction(document.getElementById("map_ol"), "openlayers", true);

                // set default controls and map type
                map.addControls({
                    pan: true,
                    zoom: true ? 'large' : false,
                    map_type: true
                });

                map.setMapType(mxn.Mapstraction.ROAD);

                var tracksShown = false;

                if (!tracksShown) {
                    // display the map centered on a latitude and longitude
                    var startpt = new mxn.LatLonPoint(35, -95);
                    map.setCenterAndZoom(startpt, 5);
                }

            }

            function set_speed_mult(val) {
                speed_mult = val;
            }
	    
	    function clear_map() {
		map.removeAllMarkers();
		map.removeAllPolylines();
            }
	    
	    function get_available_colour(trackIndex) {
		var colors = ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#00ffff", "#ff00ff", "#000000", "#ffffff"];
		var n = colors.length;
		return colors[trackIndex % n];
            }
	    
	    function reset() {
                clear_map();
		$("#playPause").attr("class", "play");
		$( "#slider" ).slider("value", 0.0);
		start = 0.0;
		end = 0.0;
            }
	    
	    function set_elapsed_time_display(){
	        var currentPos = 0.0;
		if(end){
			currentPos = end;
			}
			
		var displayValue = currentPos / 1000;
		var displayOffset = longestTimeOffset / 1000;
		var displayText = displayValue + "/" + displayOffset;
		$( "#amount" ).val(displayText);
	    }

            // Display all of the tracks from a GPX file at the specified
            // zoom level. Input from the UI determines whether we will
            // animate the track or display it statically.
	    // todo - add a start time 
	    // if 0 or undefined run  setup
	    // else just animate or display
            function showtracks() {
                var colors = ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#00ffff", "#ff00ff", "#000000", "#ffffff"],
		zoom = 5;
		var timeout_id = 0;

		if(!isSetup || goingBackwards){
			clear_map();
			
			if(goingBackwards){
			goingBackwards = false;
			}
		}
		
		if($('#IncrementButton').attr('checked') == "undefined"){
			showIncrement = false;
		} else { 
			showIncrement = $('#IncrementButton').attr('checked') == "checked";
		}

                // Setup function to center and zoom the map appropriately
                // to display the tracks
		// precon - if there are tracks that they are valid
                var f_setup = function (f_next) {	                        
			var tracksLength = tracks.length;
                        var theMinLon = 180.0;
                        var theMaxLon = -180.0;
                        var theMinLat = 90.0;
                        var theMaxLat = -90.0;
			var badFiles = new Array(); // should not be needed cos of the precon

                        for (var i = 0; i < tracksLength; ++i) {
                            var bounds = tracks[i].theBounds;
			    
			    if(bounds === null){
			         var theFileName = tracks[i].fileName;
				 badFiles.push(theFileName);
			    } else {
				    theMinLon = Math.min(theMinLon, bounds.sw.lon);
				    theMaxLon = Math.max(theMaxLon, bounds.ne.lon);
				    theMinLat = Math.min(theMinLat, bounds.sw.lat);
				    theMaxLat = Math.max(theMaxLat, bounds.ne.lat);
			    }
                        };

                        var centerLon = (theMaxLon + theMinLon) / 2.,
                            centerLat = (theMinLat + theMaxLat) / 2.;

                        // Try to determine the best zoom level using the bounding-box
                        // information from the file.
                        var theBounds = {
                            minX: theMinLon,
                            maxX: theMaxLon,
                            minY: theMinLat,
                            maxY: theMaxLat
                        };

                        // Google map zoom is different to OpenLayers zoom
                        zoom = 17 - best_zoom(theBounds, document.getElementById("map_ol"));
                        map.setCenterAndZoom(new mxn.LatLonPoint(centerLat, centerLon), zoom);

                        isSetup = true;
			start = 0.0;
			//~ end = 1.0;
			
                        f_next();
                    }

                    // Animate the tracks
                var f_animate = function () {
		if(!end){
		   end = 1.0;
		}
		
		if(end === 0.0){
		   end = 1.0;
		   }
			animateTracks();
                    };
		    
		var animateTracks = function () {
		        if(showIncrement === true){
				map.removeAllPolylines();
				}
		      f_display();
		      
		      if(end < longestTimeOffset){
		      var noOfIncrements = 0.0;
		      if(end < 2.0){
		          end = 0.0;
			  //~ start = 0.0;
			  noOfIncrements = 0;
			  } else {
			      noOfIncrements = end / sliderTimeIncrement;
			}
			      
		      $( "#slider" ).slider("value", noOfIncrements);
		      				if(showIncrement === true){
					start = end;
					}
		      end = end + sliderTimeIncrement;
		      timeout_id = setTimeout(animateTracks, sliderTimeIncrement / speed_mult);
		      } else {
			$('#playPause').click();
		      }
                    };
		    
	      fcancel = function(){
	          if(timeout_id > 0){
		    clearTimeout(timeout_id);
		    }
		    };

                // Display the tracks.
                var f_display = function () {
                        var tracksLength = tracks.length;

                        for (var i = 0; i < tracksLength; ++i) {
                            tracks[i].display(map, colors, start, end);
                        }
                    };

                if (speed_mult == 0 || $("#playPause").attr("class") == "play") {
		    if(isSetup){
		        f_display();
		    } else {
		       f_setup(f_display);
		    }
                } else {
		    if(isSetup){
		        f_animate();
		    } else {
		       f_setup(f_animate);
		    }
                }
            }

	function listbox_remove(sourceID) {
                //get the listbox object from id.
                var src = document.getElementById(sourceID);
		var removedItems = new Array();

                //iterate through each option of the listbox
                for (var count = src.options.length - 1; count >= 0; count--) {
                    //if the option is selected, delete the option
                    if (src.options[count].selected == true) {
		        var itemText = src.options[count].text;
			removedItems.push(count);
			
                        try {
                            src.remove(count, null);
                        } catch (error) {
                            src.remove(count);
                        }
                    }
                }

		// rebuild the tracks
		var newTracks = new Array();
                var tracksLength = tracks.length;
		var removedItemsLength = removedItems.length;
		for (var i = 0; i < tracksLength; ++i) {
		    var matchFound = false;
		    for(var j = 0; j < removedItemsLength; ++j){
		          if(j === i){
			      matchFound = true;
			  }
		    }
		    if(!matchFound){
		        newTracks.push(tracks[i]);
		    }
		}
		tracks = newTracks;
		
		isSetup = false;
		reset();
		set_elapsed_time_display();
            }
	    
	    function completeAdd(theTrack){
		tracks.push(theTrack);
		longestTimeOffset = 0.0;
		
		var tracksLength = tracks.length;
		for (var i = 0; i < tracksLength; ++i) {
			longestTimeOffset = Math.max(longestTimeOffset, tracks[i].elapsedTime);
		}
		
		sliderTimeIncrement = longestTimeOffset / 100;
		
		var listBox = document.getElementById('lsbox');

                var listBoxItem = document.createElement("option");
                listBoxItem.value = theTrack.fileName;
                listBoxItem.text = theTrack.fileName;
                listBox.add(listBoxItem, null);	  

                isSetup = false;
		set_elapsed_time_display();
	    }
	    
	    function errorAdd(itemText){
	    // todo just move this as an alert to GPSTrack
	    }

            function addNewListItem() {
		var listBox = document.getElementById('lsbox');
                var itemValue = document.getElementById('txtValue');

                if (itemValue.value == '') {
                    alert('please enter option value');
                    itemValue.focus();
                    return false;
                }

                if (isOptionAlreadyExist(listBox, itemValue.value)) {
                    alert('already exists');
                    itemValue.focus();
                    return false;
                }
		
		var trackIndex = tracks.length;
		var trackColour = get_available_colour(trackIndex);
		var theTrace = new GPSTrack(itemValue.value, trackColour, completeAdd, errorAdd);
                var fetched = theTrace.fetch();

                return true;
            }

            function isOptionAlreadyExist(listBox, value) {
                var exists = false;
                for (var x = 0; x < listBox.options.length; x++) {
                    if (listBox.options[x].value == value || listBox.options[x].text == value) {
                        exists = true;
                        break;
                    }
                }
                return exists;
            }
	    
	                //]]>
			
	    </script>

		<script type="text/javascript">
	$(function() {
		$( "#slider" ).slider({
			value:0,
			min: 0,
			max: 100,
			step: 1,
			slide: function( event, ui ) {
			        if($("#playPause").attr("class") == "pause"){
				    $("#playPause").click();
				}
			        var sliderValue = ui.value;
				end = (longestTimeOffset * ui.value) / 100;
				if(start > end){
					start = 0.0;
					goingBackwards = true;
				}
				set_elapsed_time_display();
				showtracks();
				start = end;
			}
		});
		$( "#amount" ).val($( "#slider" ).slider( "value" ) );
	});
	</script>
        <script type="text/javascript">
            $(document).ready(function () {
                $('#playPause').bind("click", function () {
                    if ($(this).attr("class") == "play"){
		    //todo - add a time to showtracks so that it knows where it was paused
		        $(this).attr("class", "pause");
			if (speed_mult == 0){
			    end = longestTimeOffset;
			    $( "#slider" ).slider("value", 100.0);
			    // todo - set the elapsed time value
			    $(this).attr("class", "play");
			}
			// if this is a display 
			// change end to largest offset
			// move slider to end
			showtracks();
                   } else {
			if(fcancel){
			    fcancel();
			    }
			   $(this).attr("class", "play");
		       }
                });
		$('#stop').bind("click", function () {
		    if(fcancel){
		        fcancel();
			}
                   reset();
		   set_elapsed_time_display();
                });
            });
        </script>
    </head>
    
    <body onload="initialize()">
        <div id="intro">
            <h2 id="title">GPS Track Plotting/Animation Demo</h2>
            <p>This page uses Google's new
                <a href="http://maps.google.com/apis/maps/documentation/">Mapping API</a>to plot and optionally animate various GPS tracks. Each example track
                is stored in a
                <a href="http://www.topografix.com/gpx.asp">GPX-format</a>XML file.</p>
            <h3 class="subhead">Animation</h3>
            <p>The animation update interval is determined by the time between trackpoints.
                You can play the animation in real-time (this can be rather slow) or some
                multiple thereof. There is also the option of elevation dependent coloring
                for each trackpoint interval. The color range is a linear progression in
                <a
                href="http://gug.sunsite.dk/docs/Grokking-the-GIMP-v1.0/node51.html">hue</a>(i.e. around the color wheel) from zero to the specified maximum
                    elevation.</p>
            <h3 class="subhead">Source code</h3>
            <p>The GPX handling is provided by the functions in
                <a href="http://home.mindspring.com/%7Emfkenney/gmapgpx.js">gmapgpx.js</a>and the color conversion is done in
                <a href="http://home.mindspring.com/%7Emfkenney/colors.js">colors.js</a>.</p>
        </div>

	<table id="map_table">
                <tr>
                <td>		
        <div style="background-color: rgb(229, 227, 223);" id="map_ol">
	</td>
	</tr>
	<tr>
	    <td>
 		<span> 
		    <div id="stop" class="stop"></div>
                    <div id="playPause" class="play"></div>
		<div id="slider"></div>
                 </span>      
                </td>
                </tr>
		<tr>
		<td>
	          <label for="amount">Elapsed time (1% increments):</label>
	           <input type="text" id="amount" style="border:0; color:#f6931f; font-weight:bold;" />
		   </td>
		</tr>
	</table>
	
            <div id="info">
                <p>Select animation speed:</p>
                <form>
                    <select id="speed" name="speed" size="1" onchange="set_speed_mult(this.options[this.selectedIndex].value)">
                        <option selected="selected" value="0">no animation</option>
                        <option value="1">real-time</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                        <option value="20">20x</option>
                        <option value="50">50x</option>
			<option value="100">100x</option>
                    </select>
                </form>

                <p>Select display type:</p>
<Input type = radio Name = r1 Value = "Full" id="FullTrackButton" checked=true>Full track
<Input type = radio Name = r1 Value = "Increment" id="IncrementButton">Increment

<!-- if (document.f1.r1[i].checked)
chosen = document.f1.r1[i].value -->

                <p>Add GPS tracks to the list below.
		Animation/plotting will start/stop when you press the play/pause button.</p>
        <table>
            <tr>
                <td align="left">
                    <input name="txtValue" type="text" id="txtValue"
                    />
                </td>
            </tr>
            <tr>
                <td align="center">
                    <button name="btnAddItem" id="btnAddItem" onclick="javascript:addNewListItem();">Add</button>
                </td>
                <tr>
                    <tr>
                        <td align="center">
                            <select id="lsbox" name="lsbox" size="10" multiple>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td align="center">
                            <button onclick="listbox_remove('lsbox');">Delete</button>
                        </td>
                    </tr>
        </table>
            </div>
    </body>

</html>